<app-header titulo="Elementos de Protección"></app-header>

<ion-content>
  <!-- Lista de Elementos con Tarjetas -->
  <ion-list>
    <ion-card *ngFor="let item of elementosProteccion">
      <ion-card-header>
        <ion-card-title>Dotación</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p><strong>Fecha de Asignación:</strong> {{ item.fechaAsignacion | date }}</p>
        <p><strong>Nº de Elementos Asignados:</strong> {{ item.cantidadElementos }}</p>
        <p><strong>Elementos Asignados:</strong></p>
        <ul [innerHTML]="item.elementos"></ul>
        <p><strong>Costo Total:</strong> {{ item.costoTotal | currency }}</p>
      </ion-card-content>

      <ion-button 
        expand="full" 
        [disabled]="item.cantidadFirmas === item.cantidadElementosParaFirmas" 
        [color]="item.cantidadFirmas === item.cantidadElementosParaFirmas ? 'medium' : 'primary'" 
        (click)="openModalFirmas(item)">
        {{ item.cantidadFirmas === item.cantidadElementosParaFirmas ? 'Firmado' : 'Firmar' }}
      </ion-button>
    </ion-card>
  </ion-list>

  <!-- Botones flotantes para acciones -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" style="margin-bottom: 60px;">
    <ion-fab-button (click)="openModal()" color="warning">
      <fa-icon [icon]="['fas', 'filter']"></fa-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="reiniciarFiltros()" color="medium">
      <fa-icon [icon]="['fas', 'filter-circle-xmark']"></fa-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Modal para Filtrar por Fecha -->
  <ion-modal [isOpen]="isModalOpen">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title class="text-center">Filtrar por Fecha</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <form [formGroup]="filtroForm">
          <ion-item>
            <ion-label position="floating" for="selectFechaInicio" color="dark">* Fecha Inicio</ion-label>
            <ion-input name="fechainicio" id="selectFechaInicio" expand="block"  display-format="DD-MM-YYYY"  
            presentation='date' required readonly></ion-input>
              <ion-popover trigger="selectFechaInicio" size="cover">
                <ng-template>
                  <ion-datetime display-format="DD-MM-YYYY"  
                    presentation='date' id="Fechainicio" [showDefaultButtons]="true" doneText="Confirmar" cancelText="Cancelar" (ionChange)="confirmarInicio()"></ion-datetime>
                </ng-template>
              </ion-popover>
          </ion-item>

          <ion-item>
            <ion-label position="floating" for="selectFechaInicio" color="dark">* Fecha Fin</ion-label>
            <ion-input name="fechafin" id="selectFechaFin" expand="block"  display-format="DD-MM-YYYY"  
            presentation='date' required readonly></ion-input>
              <ion-popover trigger="selectFechaFin" size="cover" alignment="end">
                <ng-template>
                  <ion-datetime display-format="DD-MM-YYYY"  
                    presentation='date' id="FechaFin" [showDefaultButtons]="true" doneText="Confirmar" cancelText="Cancelar" (ionChange)="confirmarFin()"></ion-datetime>
                </ng-template>
              </ion-popover>
          </ion-item>
          <!-- Botón Filtrar -->
          <ion-button expand="full" (click)="filtrarPorFecha()">Filtrar</ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal para Firma -->
  <ion-modal [isOpen]="isFirmaModalOpen">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Aprobación de Entrega</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeFirmaModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-button expand="block" (click)="openModalClave()">
          <ion-icon slot="start" name="key"></ion-icon> Firma con Clave
        </ion-button>
        <ion-button expand="block" (click)="openQRModalImproved()">
          <ion-icon slot="start" name="qr-code"></ion-icon> Firma con QR
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal para Firma con QR -->
  <ion-modal #modalQR [isOpen]="isQRModalOpen" (didPresent)="onQRModalDidPresent()" (willDismiss)="onQRModalWillDismiss()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Firma con QR</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeQRModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div style="position: relative; width: 100%; height: 400px; background: #000;">
          <video #videoQR style="width: 100%; height: 100%; object-fit: cover;"></video>
          <div *ngIf="validandoClave" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px;">
            Validando...
          </div>
        </div>
        <ion-text style="display: block; text-align: center; margin: 20px; color: #666;">
          Enfoca el código QR en el recuadro para escanearlo
        </ion-text>
        <ion-button expand="full" (click)="closeQRModal()" color="medium">
          <ion-icon slot="start" name="close"></ion-icon>
          Cancelar
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
